<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-item/paper-icon-item.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <birch-typeahead></birch-typeahead>

Example:

    <birch-typeahead>
      <div>[[item.label]]</div>
    </birch-typeahead>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-typeahead">
  <link rel="import" type="css" href="birch-typeahead.css">
  <template>
    <!-- Using the content tag to allow users to pass in a custom options template -->
    <content>
      <!-- This is the default options template used if the user does not provide an override -->
      <template id="defaultTemplate">
        <paper-item>[[item.label]]</paper-item>
      </template>
    </content>

    <div id="container">
      <input id="input"
        placeholder$="[[placeholder]]"
        autofocus$="[[autofocus]]"
        class$="[[_class('loading', loading)]]"
        on-keydown="_handleKeydown"
        on-keyup="_handleKeyup"
        on-focus="_handleFocus"
        on-blur="_handleBlur"/>
      <paper-menu id="optionsContainer" tabindex="-1" on-tap="_handleTap">
        <template is="dom-repeat" id="userTemplate" items="[[_options]]"></template>
      </paper-menu>
    </div>
  </template>

  <script>
    Polymer({
      is: 'birch-typeahead',

      properties: {
        loading: {
          type: Boolean,
          value: false
        },
        debounceInputDuration: {
          type: Number,
          value: 0
        },
        highlightFirstItem: {
          type: Boolean,
          valaue: false
        },
        placeholder: {
          type: String,
          value: ''
        },
        autofocus: {
          type: Boolean,
          value: false
        },
        _options: {
          type: Array,
          value: function(){ return []; }
        },
        _inputVal: {
          type: String,
          value: ''
        },
        _hasFocus: {
          type: Boolean,
          value: false
        },
        _usingCustomTemplate: {
          type: Boolean,
          value: false
        }
      },

      /**
       * The ready function templatizes either the custom template provided
       * by the user or the default template within this component.
       */
      ready: function(){
        var template = this.$.defaultTemplate;
        // For now, a user's custom options template must have an id of
        // "birch-typeahead-template" in order to be recognized.
        var customTemplate = Polymer.dom(this).querySelector('template');
        if(customTemplate){
          template = customTemplate;
          this._usingCustomTemplate = true;
        }
        this.$.userTemplate.templatize(template);
        Polymer.Bind.prepareModel(this.$.userTemplate);
        Polymer.Base.prepareModelNotifyPath(this.$.userTemplate);
        this._handleShadyDomSetup();
      },

      /**
       * Sets the typeahead options. Accepts an array of objects.
       */
      setOptions: function(options){
        if(options && Array.isArray(options) && options.length){
          this._showOptions(options);
          if(this.highlightFirstItem){
            this.$.optionsContainer.select(0);
            this.$.input.focus();
          }
        }
      },

      _handleKeydown: function(e){
        if(!e || !e.which) return;
        switch(e.which){
          case 38:  this._handleUpArrow(e);     break;
          case 40:  this._handleDownArrow(e);   break;
          case 9:   this._handleTab(e);         break;
          case 13:  this._handleEnter(e);       break;
          case 27:  this._handleEscape(e);      break;
        }
      },

      _handleKeyup: function(e){
        if(this.$.input.value.toLowerCase() !== this._inputVal.toLowerCase()){
          this._inputVal = this.$.input.value;
          this.debounce('birch-typeahead:changed', function(){
            this.fire('birch-typeahead:changed', {value: this._inputVal});
          }.bind(this), this.debounceInputDuration);
          if(!this._inputVal) this._hideOptions();
        }
      },

      _handleUpArrow: function(e){
        if(!this._options.length) return;
        e.preventDefault();
        var optionsMenu = this.$.optionsContainer;
        var index = Math.max(optionsMenu.selected - 1, 0);
        optionsMenu.select(index);
        this.$.input.focus();
      },

      _handleDownArrow: function(e){
        if(!this._options.length) return;
        e.preventDefault();
        var optionsMenu = this.$.optionsContainer;
        var index = Math.min(optionsMenu.selected + 1, this._options.length - 1);
        optionsMenu.select(index);
        this.$.input.focus();
      },

      _handleTab: function(e){
        if(!this._options.length) return;
        e.preventDefault();
        this._selectActiveItem();
      },

      _handleEnter: function(e){
        this._selectActiveItem();
      },

      _handleEscape: function(e){
        this._hideOptions();
        this.fire('birch-typeahead:cancel');
      },

      _handleFocus: function(e){
        this._hasFocus = true;
      },

      _handleBlur: function(e){
        var child = e.relatedTarget;
        var parent = this.$.optionsContainer;
        if(parent.contains(child)) return;
        this._hasFocus = false;
        this._hideOptions();
        this.fire('birch-typeahead:cancel');
      },

      _handleTap: function(e){
        if(!e) return;

        var counter = 0;
        var el = Polymer.dom(e).rootTarget;
        if(!this.$.optionsContainer.contains(el)) return;

        // This is necessary to acommidate shady dom.
        // Find the top-level option element, regardless
        // of what type of element it is. It allows the
        // user to not have to pass the on-tap handler.
        while(el.parentNode){
          counter++;
          if(counter === 9) break;
          var parent = el.parentNode;
          if(parent.nodeName !== 'PAPER-MENU'
            && !parent.classList.contains('selectable-content')){
            el = el.parentNode;
          } else {
            break;
          }
        }

        var fakeEvent = {currentTarget: el};
        this._selectActiveItem(fakeEvent);
      },

      _selectActiveItem: function(e){
        var index;
        var optionsMenu = this.$.optionsContainer;

        if(e && e.currentTarget){
          var selectedItem = e.currentTarget;
          index = Number(optionsMenu.indexOf(selectedItem));
        } else {
          var selectedItem = optionsMenu.selectedItem;
          index = Number(optionsMenu.indexOf(selectedItem));
        }

        if(typeof index !== 'number' || index === -1) return;
        optionsMenu.select(index);

        if(e && e.type === 'mouseover') return;
        var selection = this._options[index];
        this._inputVal = selection.customText || selection.standardText || '';
        this.$.input.value = selection.customText || selection.standardText;
        selection.customText = this._inputVal;
        this.fire('birch-typeahead:selected', {selection: selection, options: this._options});
        this._hideOptions();
      },

      _showOptions: function(data){
        if(this._hasFocus) this._options = data;
      },

      _hideOptions: function(){
        this._options = [];
      },

      _class: function(className, bool){
        return bool ? className : '';
      },

      _handleShadyDomSetup: function(){
        // Really ugly support for custom, external templates in shady dom.
        // Only applied if a custom template is provided and shady dom is used.
        if(!window.Polymer || !window.Polymer.Settings) return;
        var settings = window.Polymer.Settings;
        if(this._usingCustomTemplate && !settings.useNativeShadow && !settings.useShadow){
          this.$.optionsContainer.addEventListener('iron-items-changed', function (e){
            var items = this.$.optionsContainer.items;
            for(var i = 0; i < items.length; i++){
              items[i].classList.add('style-scope', 'birch-typeahead');
            }
            Polymer.updateStyles();
          }.bind(this));
        }
      }

    });
  </script>
</dom-module>
