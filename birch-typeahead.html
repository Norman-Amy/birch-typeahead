<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../paper-menu/paper-menu.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../paper-item/paper-icon-item.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <birch-typeahead></birch-typeahead>

Example:

    <birch-typeahead>
      <div>[[item.label]]</div>
    </birch-typeahead>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-typeahead">
  <template>
    <style>
      :host {
        display: block;
        box-sizing: border-box;
        font-family: verdana;
        font-size: 14px;
      };
      ::content * {
        font-family: verdana !important;
      };
      paper-icon-item, paper-item {
        --paper-item: {
          font-family: verdana;
          @apply(--birch-typeahead-paper-item);
        };
        --paper-item-selected: {
          font-weight: 100 !important;
          background-color: #ecebea !important;
          @apply(--birch-typeahead-paper-item-selected);
        };
        --paper-item-icon-width: 25px;
        @apply(--birch-typeahead-paper-item-icon-width);
      }
      paper-menu {
        --paper-menu: {
          font-family: verdana
          @apply(--birch-typeahead-paper-menu);
        };
      }
      paper-item > *, paper-item-body > * {
        white-space: normal !important;
        font-size: 14px !important;
      }
      #container {
        max-width: 300px;
        position: relative;
      }
      input {
        width: 100%;
        font-size: 14px;
      }
      #optionsContainer {
        position: absolute;
        padding: 0;
        width: 100%;
        max-height: 200px;
        overflow-y: scroll;
        overflow-x: hidden;
        cursor: pointer;
        box-shadow: 0px 5px 10px grey;
        -webkit-overflow-scrolling: touch;
      }
      .loading {
        background-color: #ffffff;
        background-image: url("http://loadinggif.com/images/image-selection/3.gif");
        background-size: 25px 25px;
        background-position:right center;
        background-repeat: no-repeat;
      }
    </style>

    <!-- The content tag allows users to pass in a custom options template -->
    <content>
      <!-- This is the default options template used if the user does not provide an override -->
      <template id="defaultTemplate">
        <paper-item on-tap="_selectActiveItem">[[item.label]]</paper-item>
      </template>
    </content>

    <div id="container">
      <input id="input"
        placeholder="[[placeholder]]"
        autofocus$="[[autofocus]]"
        class$="[[_class('loading', loading)]]"
        on-keydown="_handleKeydown"
        on-keyup="_handleKeyup"
        on-focus="_handleFocus"
        on-blur="_handleBlur"/>
      <paper-menu id="optionsContainer" tabindex="-1">
        <template is="dom-repeat" id="userTemplate" items="[[_options]]"></template>
      </paper-menu>
    </div>
  </template>

  <script>
    Polymer({
      is: 'birch-typeahead',

      properties: {
        loading: {
          type: Boolean,
          value: false
        },
        debounceInputDuration: {
          type: Number,
          value: 0
        },
        highlightFirstItem: {
          type: Boolean,
          valaue: false
        },
        placeholder: {
          type: String,
          value: ''
        },
        autofocus: {
          type: Boolean,
          value: false
        },
        _options: {
          type: Array,
          value: function(){ return []; }
        },
        _inputVal: {
          type: String,
          value: ''
        },
        _hasFocus: {
          type: Boolean,
          value: false
        }
      },

      /**
       * The ready function templatizes either the custom template provided
       * by the user or the default template within this component.
       */
      ready: function(){
        var template = this.querySelector('#birch-typeahead-template') || this.$.defaultTemplate;
        this.$.userTemplate.templatize(template);
        Polymer.Bind.prepareModel(this.$.userTemplate);
        Polymer.Base.prepareModelNotifyPath(this.$.userTemplate);
      },

      /**
       * Sets the typeahead options. Accepts an array of objects.
       */
      setOptions: function(options){
        if(options && Array.isArray(options) && options.length){
          this._showOptions(options);
          if(this.highlightFirstItem){
            this.$.optionsContainer.select(0);
            this.$.input.focus();
          }
        }
      },

      _handleKeydown: function(e){
        if(!e || !e.which) return;
        switch(e.which){
          case 38:  this._handleUpArrow(e);     break;
          case 40:  this._handleDownArrow(e);   break;
          case 9:   this._handleTab(e);         break;
          case 13:  this._handleEnter(e);       break;
          case 27:  this._handleEscape(e);      break;
        }
      },

      _handleKeyup: function(e){
        if(this.$.input.value.toLowerCase() !== this._inputVal.toLowerCase()){
          this._inputVal = this.$.input.value;
          this.debounce('birch-typeahead:changed', function(){
            this.fire('birch-typeahead:changed', {value: this._inputVal});
          }.bind(this), this.debounceInputDuration);
          if(!this._inputVal) this._hideOptions();
        }
      },

      _handleUpArrow: function(e){
        if(!this._options.length) return;
        e.preventDefault();
        var optionsMenu = this.$.optionsContainer;
        var index = Math.max(optionsMenu.selected - 1, 0);
        optionsMenu.select(index);
        this.$.input.focus();
      },

      _handleDownArrow: function(e){
        if(!this._options.length) return;
        e.preventDefault();
        var optionsMenu = this.$.optionsContainer;
        var index = Math.min(optionsMenu.selected + 1, this._options.length - 1);
        optionsMenu.select(index);
        this.$.input.focus();
      },

      _handleTab: function(e){
        if(!this._options.length) return;
        e.preventDefault();
        this._selectActiveItem();
      },

      _handleEnter: function(e){
        this._selectActiveItem();
      },

      _handleEscape: function(e){
        this._hideOptions();
      },

      _handleFocus: function(e){
        this._hasFocus = true;
      },

      _handleBlur: function(e){
        var child = e.relatedTarget;
        var parent = this.$.optionsContainer;
        if(parent.contains(child)) return;
        this._hasFocus = false;
        this._hideOptions();
      },

      _selectActiveItem: function(e){
        var index;
        var optionsMenu = this.$.optionsContainer;

        if(e && e.currentTarget){
          var selectedItem = e.currentTarget;
          index = Number(optionsMenu.indexOf(selectedItem));
        } else {
          var selectedItem = optionsMenu.selectedItem;
          index = Number(optionsMenu.indexOf(selectedItem));
        }

        if(typeof index !== 'number') return;
        optionsMenu.select(index);

        if(e && e.type === 'mouseover') return;
        var selection = this._options[index];
        this._inputVal = selection.customText || selection.standardText || '';
        this.$.input.value = selection.customText || selection.standardText;
        selection.customText = this._inputVal;
        this.fire('birch-typeahead:selected', {selection: selection});
        this._hideOptions();
      },

      _showOptions: function(data){
        if(this._hasFocus) this._options = data;
      },

      _hideOptions: function(){
        this._options = [];
      },

      _class: function(className, bool){
        return bool ? className : '';
      }

    });
  </script>
</dom-module>
