<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
    <title>birch-typeahead Demo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"></script>
    <script src="../../webcomponentsjs/webcomponents-lite.min.js"></script>
    <script type="text/javascript">
      window.Polymer = {dom: 'shadow'};
    </script>
    <link rel="import" href="../birch-typeahead.html">
  </head>
  <body unresolved>

    <input id="sessionId" placeholder="Int SessionId"/>

    <br/><br/>

    <birch-typeahead
      highlight-first-item
      placeholder="Enter a place"
      debounce-input-duration="250">

      <template id="birch-typeahead-template">
        <paper-item on-tap="_selectActiveItem">
          <paper-item-body two-line>
            <div>[[item.label]]</div>
            <div secondary>[[item.type]]</div>
          </paper-item-body>
        </paper-item>
      </template>

    </birch-typeahead>

    <script>
      var typeahead = document.getElementsByTagName('birch-typeahead')[0];
      var sessionIdInput = document.getElementById('sessionId');

      function fetchData(input){
        var uri = 'https://integration.familysearch.org/platform/places/search';
        var url = uri + '?q=partialName:"' + input + '"';
        var init = {
          headers: {
            'Accept': 'application/json',
            'Authorization': 'Bearer ' + sessionIdInput.value
          }
        }

        return fetch(url, init).then(res => res.json());
      }

      function mapData(entries){
        return entries.map(function (item){
          var info = item.content.gedcomx.places[0];
          return {
            id: info.id,
            label: info.display.fullName,
            standardText: info.display.fullName,
            type: info.display.type,
            customText: null
          }
        });
      }

      typeahead.addEventListener('birch-typeahead:changed', function (e){
        if(!e || !e.detail || !e.detail.value) return;

        typeahead.loading = true;
        fetchData(e.detail.value).then(function (data){
          typeahead.loading = false;
          if (!data || !data.entries) return;

          var entries = mapData(data.entries);
          if(entries && entries.length){
            typeahead.setOptions(entries);
          }
        });
      });
    </script>
  </body>
</html>
